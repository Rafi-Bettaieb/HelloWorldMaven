pipeline {
    agent any

    environment {
        GIT_CREDENTIALS_ID = 'github-token'
        GIT_REPO = 'https://github.com/Rafi-Bettaieb/HelloWorldMaven.git'
        GIT_BRANCH = 'master'
    }

    // IMPORTANT: You MUST go to Jenkins > Manage Jenkins > Tools
    // and create a Maven installation named EXACTLY "Maven3"
    tools {
        maven 'Maven3' 
    }

    triggers {
        pollSCM('* * * * *')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${env.GIT_BRANCH}"]],
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [[$class: 'CloneOption', shallow: false]],
                    userRemoteConfigs: [[
                        url: env.GIT_REPO,
                        credentialsId: env.GIT_CREDENTIALS_ID
                    ]]
                ])
            }
        }

        stage('Build') {
            steps {
                // The 'tools' block adds mvn to the path automatically
                sh "mvn clean install"
            }
        }

        stage('Tag and Push') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'jenkins-token',
                    usernameVariable: 'GIT_USERNAME',
                    passwordVariable: 'GIT_TOKEN'
                )]) {
                    script {
                        def TAG_NAME = "build-${env.BUILD_NUMBER}"
                        sh """
                            git config user.email "rafii.bettaieb004@gmail.com"
                            git config user.name "Rafi-Bettaieb"
                            
                            git checkout ${env.GIT_BRANCH}
                            git pull origin ${env.GIT_BRANCH}
                            
                            git tag -a ${TAG_NAME} -m "Build ${env.BUILD_NUMBER}"
                            git push https://${GIT_USERNAME}:${GIT_TOKEN}@github.com/Rafi-Bettaieb/HelloWorldMaven.git ${TAG_NAME}
                        """
                    }
                }
            }
        }
    }
}
