pipeline {
    agent any

    environment {
        GIT_CREDENTIALS = 'github-token'
        GIT_REPO = 'https://github.com/Rafi-Bettaieb/HelloWorldMaven.git'
        GIT_BRANCH = 'master'
    }

    triggers {
        pollSCM('* * * * *')
    }

    stages {

        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${env.GIT_BRANCH}"]],
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [
                        [$class: 'CloneOption', shallow: false] // prevents shallow clone
                    ],
                    userRemoteConfigs: [[
                        url: env.GIT_REPO,
                        credentialsId: env.GIT_CREDENTIALS
                    ]]
                ])
            }
        }

        stage('Build') {
            steps {
                sh "mvn clean install"
            }
        }

        stage('Tag and Push') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'jenkins-token',
                    usernameVariable: 'GIT_USERNAME',
                    passwordVariable: 'GIT_TOKEN'
                )]) {

                    script {
                        def TAG_NAME = "build-${env.BUILD_NUMBER}"

                        sh """
                            git config user.email "rafii.bettaieb004@gmail.com"
                            git config user.name "Rafi-Bettaieb"

                            # Make sure we are not in a detached HEAD
                            git checkout ${env.GIT_BRANCH}

                            git pull origin ${env.GIT_BRANCH}

                            git tag -a ${TAG_NAME} -m "Build ${env.BUILD_NUMBER}"

                            git push https://${GIT_USERNAME}:${GIT_TOKEN}@github.com/Rafi-Bettaieb/HelloWorldMaven.git ${TAG_NAME}
                        """
                    }
                }
            }
        }
    }
}
