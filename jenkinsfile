pipeline {
    // This tells Jenkins to run the whole pipeline inside a Docker container
    // that already has Maven installed.
    agent {
        docker { 
            image 'maven:3.9.6-eclipse-temurin-11' 
            args '-v /root/.m2:/root/.m2' // Optional: Cache maven dependencies
        }
    }

    environment {
        GIT_CREDENTIALS = 'github-token'
        GIT_REPO = 'https://github.com/Rafi-Bettaieb/HelloWorldMaven.git'
        GIT_BRANCH = 'master'
    }

    triggers {
        pollSCM('* * * * *')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${env.GIT_BRANCH}"]],
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [[$class: 'CloneOption', shallow: false]],
                    userRemoteConfigs: [[
                        url: env.GIT_REPO,
                        credentialsId: env.GIT_CREDENTIALS
                    ]]
                ])
            }
        }

        stage('Build') {
            steps {
                // No 'tools' block needed because the Docker image has 'mvn'
                sh "mvn clean install"
            }
        }

        stage('Tag and Push') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'jenkins-token',
                    usernameVariable: 'GIT_USERNAME',
                    passwordVariable: 'GIT_TOKEN'
                )]) {
                    script {
                        def TAG_NAME = "build-${env.BUILD_NUMBER}"
                        sh """
                            git config user.email "rafii.bettaieb004@gmail.com"
                            git config user.name "Rafi-Bettaieb"
                            
                            git checkout ${env.GIT_BRANCH}
                            git pull origin ${env.GIT_BRANCH}
                            
                            git tag -a ${TAG_NAME} -m "Build ${env.BUILD_NUMBER}"
                            git push https://${GIT_USERNAME}:${GIT_TOKEN}@github.com/Rafi-Bettaieb/HelloWorldMaven.git ${TAG_NAME}
                        """
                    }
                }
            }
        }
    }
}
